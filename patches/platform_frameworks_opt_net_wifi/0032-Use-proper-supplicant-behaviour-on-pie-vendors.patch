From dd2cbb559e0826dcb7a98d58ddf20f197a7960f1 Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Sun, 3 Nov 2019 17:10:32 +0100
Subject: [PATCH 32/32] Use proper supplicant behaviour on >=pie vendors

---
 .../android/server/wifi/SupplicantStaIfaceHal.java   |  2 +-
 service/java/com/android/server/wifi/WifiNative.java | 12 +++++++++---
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/service/java/com/android/server/wifi/SupplicantStaIfaceHal.java b/service/java/com/android/server/wifi/SupplicantStaIfaceHal.java
index 5bf44ce66..a3b1b9346 100644
--- a/service/java/com/android/server/wifi/SupplicantStaIfaceHal.java
+++ b/service/java/com/android/server/wifi/SupplicantStaIfaceHal.java
@@ -577,7 +577,7 @@ public class SupplicantStaIfaceHal {
      * Check if the device is running V1_1 supplicant service.
      * @return
      */
-    private boolean isV1_1() {
+    /* package */ boolean isV1_1() {
         synchronized (mLock) {
             try {
                 return (getSupplicantMockableV1_1() != null);
diff --git a/service/java/com/android/server/wifi/WifiNative.java b/service/java/com/android/server/wifi/WifiNative.java
index af8ccc8d9..fc0f135d6 100644
--- a/service/java/com/android/server/wifi/WifiNative.java
+++ b/service/java/com/android/server/wifi/WifiNative.java
@@ -335,7 +335,8 @@ public class WifiNative {
     private boolean supplicantOn = false;
     private boolean startSupplicant() {
         synchronized (mLock) {
-            if (!mIfaceMgr.hasAnyStaIface() || !supplicantOn) {
+            boolean prePieWifi = !mSupplicantStaIfaceHal.isV1_1();
+            if (!mIfaceMgr.hasAnyStaIface() || (prePieWifi && !supplicantOn)) {
                 if (!mWificondControl.enableSupplicant()) {
                     Log.e(TAG, "Failed to enable supplicant");
                     return false;
@@ -881,8 +882,8 @@ public class WifiNative {
                 mWifiMetrics.incrementNumSetupClientInterfaceFailureDueToHal();
                 return null;
             }
-	    Log.e(TAG, "Starting supplicant");
-            if (!startSupplicant()) {
+            boolean prePieWifi = !mSupplicantStaIfaceHal.isV1_1();
+            if (!prePieWifi && !startSupplicant()) {
                 Log.e(TAG, "Failed to start supplicant");
                 mWifiMetrics.incrementNumSetupClientInterfaceFailureDueToSupplicant();
                 return null;
@@ -893,6 +894,11 @@ public class WifiNative {
                 mWifiMetrics.incrementNumSetupClientInterfaceFailureDueToWificond();
                 return null;
             }
+            if (prePieWifi && !startSupplicant()) {
+                Log.e(TAG, "Failed to start supplicant");
+                mWifiMetrics.incrementNumSetupClientInterfaceFailureDueToSupplicant();
+                return null;
+            }
             if (!mSupplicantStaIfaceHal.setupIface(iface.name)) {
                 Log.e(TAG, "Failed to setup iface in supplicant on " + iface);
                 teardownInterface(iface.name);
-- 
2.17.1

